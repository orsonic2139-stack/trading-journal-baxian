<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Quest - Trading Journal</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    /* Daily Quest é¡µé¢ä¸“ç”¨æ ·å¼ */
    .quest-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .quest-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    
    .quest-header h1 {
      color: #3eb489;
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #3eb489, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .quest-header p {
      color: #9ca3af;
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ä¸»å®¹å™¨ - ä¸¤æ å¸ƒå±€ */
    .quest-main-container {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }
    
    /* å·¦ä¾§æ—¥æœŸè®°å½•åŒºåŸŸ */
    .date-history-container {
      background: linear-gradient(145deg, #1a2030, #0f1420);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      height: 600px;
      display: flex;
      flex-direction: column;
    }
    
    .date-history-header {
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .date-history-header h3 {
      color: #3b82f6;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-history-header h3::before {
      content: 'ğŸ“…';
      font-size: 1.1rem;
    }
    
    /* æ—¥æœŸåˆ—è¡¨å®¹å™¨ - å¯æ»šåŠ¨ */
    .date-list-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .date-list-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .date-list-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    .date-list-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3eb489, #3b82f6);
      border-radius: 3px;
    }
    
    .date-list-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #2d9c6f, #2563eb);
    }
    
    /* å•ä¸ªæ—¥æœŸè®°å½•é¡¹ */
    .date-history-item {
      padding: 1rem;
      margin-bottom: 0.8rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      border-left: 4px solid #3b82f6;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .date-history-item:hover {
      background: rgba(30, 41, 59, 0.7);
      transform: translateX(5px);
    }
    
    .date-history-item.active {
      background: rgba(59, 130, 246, 0.2);
      border-left-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }
    
    .date-history-item.passed {
      border-left-color: #10b981;
    }
    
    .date-history-item.failed {
      border-left-color: #ef4444;
    }
    
    .date-history-item.patience {
      border-left-color: #f59e0b;
    }
    
    .date-history-date {
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 4px;
      font-size: 1rem;
    }
    
    .date-history-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .status-passed {
      color: #10b981;
      font-weight: 600;
    }
    
    .status-failed {
      color: #ef4444;
      font-weight: 600;
    }
    
    .status-patience {
      color: #f59e0b;
      font-weight: 600;
    }
    
    /* å³ä¾§å¡ç‰‡ */
    .combined-card {
      background: linear-gradient(145deg, #1f2937, #0f172a);
      border-radius: 20px;
      padding: 2.5rem;
      position: relative;
      border: 1px solid rgba(59, 130, 246, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      overflow: hidden;
      min-height: 600px;
      display: flex;
      flex-direction: column;
    }
    
    .combined-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3eb489, #3b82f6);
    }
    
    .combined-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    /* å¡ç‰‡æ ‡é¢˜ */
    .combined-card h3 {
      color: #3b82f6;
      font-size: 1.4rem;
      margin-bottom: 2rem;
      font-weight: 700;
      text-align: center;
      margin-top: 1rem;
    }
    
    /* æ˜¾ç¤ºæ—¥æœŸåŒºåŸŸ */
    .selected-date-display {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 0.8rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .selected-date-display h4 {
      color: #94a3b8;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    #selectedDateValue {
      font-size: 1.2rem;
      font-weight: 700;
      color: #3eb489;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    #selectedDateValue::before {
      content: 'ğŸ“…';
      font-size: 1.1rem;
    }
    
    /* ç›®æ ‡å®¹å™¨ - ä¸¤æ å¸ƒå±€ */
    .targets-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }
    
    /* å•ä¸ªç›®æ ‡æ ·å¼ */
    .target-item {
      text-align: center;
      padding: 1.5rem;
      border-radius: 16px;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
    
    .target-item:hover {
      background: rgba(30, 41, 59, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .target-item h4 {
      color: #94a3b8;
      font-size: 1rem;
      margin-bottom: 0.8rem;
      font-weight: 600;
    }
    
    .target-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.8rem;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .target-desc {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    /* ç›ˆåˆ©ç›®æ ‡é¢œè‰² */
    .profit-target .target-value {
      color: #3eb489;
    }
    
    .profit-target .progress-bar {
      background: linear-gradient(90deg, #3eb489, #10b981);
    }
    
    /* äºæŸé™åˆ¶é¢œè‰² */
    .loss-limit .target-value {
      color: #3b82f6;
    }
    
    .loss-limit .progress-bar {
      background: linear-gradient(90deg, #3b82f6, #0ea5e9);
    }
    
    /* äº¤æ˜“çŠ¶æ€æ˜¾ç¤º */
    .trading-status {
      margin-top: auto;
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 16px;
      text-align: center;
    }
    
    .trading-status h4 {
      color: #94a3b8;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    #tradingStatus {
      font-size: 1.8rem;
      font-weight: 700;
      margin-top: 0.5rem;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    /* çŠ¶æ€é¢œè‰² */
    .status-passed-full {
      color: #10b981 !important;
      border-left: 4px solid #10b981;
    }
    
    .status-failed-full {
      color: #ef4444 !important;
      border-left: 4px solid #ef4444;
    }
    
    .status-patience-full {
      color: #f59e0b !important;
      border-left: 4px solid #f59e0b;
    }
    
    /* ç©ºçŠ¶æ€æç¤º */
    .empty-history {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #64748b;
      text-align: center;
      padding: 2rem;
    }
    
    .empty-history::before {
      content: 'ğŸ“Š';
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .quest-main-container {
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .quest-main-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .date-history-container {
        height: 300px;
      }
      
      .combined-card {
        padding: 2rem 1.5rem;
        min-height: 500px;
      }
      
      .selected-date-display {
        padding: 0.6rem;
      }
      
      .combined-card h3 {
        margin-top: 0.5rem;
      }
      
      .targets-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .target-item {
        padding: 1.2rem;
      }
      
      .target-value {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 480px) {
      .combined-card {
        padding: 1.5rem 1rem;
      }
      
      .target-value {
        font-size: 1.8rem;
      }
      
      #tradingStatus {
        font-size: 1.5rem;
      }
    }
    
    /* å®ŒæˆåŠ¨ç”» */
    @keyframes completeAnimation {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    .quest-complete {
      animation: completeAnimation 0.5s ease;
    }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <nav id="sidebar" class="sidebar">
    <ul>
      <li><a href="index.html" data-i18n="dashboard">Dashboard</a></li>
      <li><a href="quest.html" data-i18n="daily_quest">Daily Quest</a></li>
      <li><a href="reports.html" data-i18n="reports">Reports</a></li>
      <li><a href="settings.html" data-i18n="settings">Settings</a></li>
    </ul>
  </nav>

  <!-- ä¸»å†…å®¹ -->
  <div id="pageContent" class="page-content">
    <header>
      <button id="hamburgerBtn">â˜°</button>
      <h1 data-i18n="daily_quest">Daily Quest</h1>
    </header>

    <main>
      <div class="quest-container">
        <div class="quest-header">
          <h1 data-i18n="daily_quest_title">Daily Trading Challenges</h1>
          <p data-i18n="quest_desc">Complete daily tasks to earn rewards and improve your trading skills!</p>
        </div>

        <!-- ä¸»å®¹å™¨ - å·¦ä¾§æ—¥æœŸè®°å½• + å³ä¾§å½“æ—¥å¡ç‰‡ -->
        <div class="quest-main-container">
          <!-- å·¦ä¾§æ—¥æœŸè®°å½• -->
          <div class="date-history-container">
            <div class="date-history-header">
              <h3 data-i18n="history_records">Daily Records</h3>
            </div>
            <div class="date-list-container" id="dateHistoryList">
              <!-- æ—¥æœŸè®°å½•å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
              <div class="empty-history" id="emptyHistory">
                <p data-i18n="no_history_yet">No records yet</p>
              </div>
            </div>
          </div>
          
          <!-- å³ä¾§å¡ç‰‡ -->
          <div class="combined-card">
            <!-- é€‰æ‹©æ—¥æœŸæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="selected-date-display">
              <h4 data-i18n="selected_date">Selected Date</h4>
              <div id="selectedDateValue">Today</div>
            </div>
            
            <h3 data-i18n="trading_status">Trading Status</h3>
            
            <!-- ç›®æ ‡å®¹å™¨ -->
            <div class="targets-container">
              <!-- ç›ˆåˆ©ç›®æ ‡ -->
              <div class="target-item profit-target">
                <h4 data-i18n="daily_profit_target">Daily Profit Target</h4>
                <div class="target-value" id="profitTarget">0 / 100</div>
                <div class="target-desc" id="profitTargetDesc">10% of daily balance</div>
                <div class="progress-container">
                  <div class="progress-bar" id="profitProgress" style="width: 0%"></div>
                </div>
              </div>
              
              <!-- äºæŸé™åˆ¶ -->
              <div class="target-item loss-limit">
                <h4 data-i18n="daily_loss_limit">Daily Loss Limit</h4>
                <div class="target-value" id="lossLimit">0 / 250</div>
                <div class="target-desc" id="lossLimitDesc">25% of daily balance</div>
                <div class="progress-container">
                  <div class="progress-bar" id="lossProgress" style="width: 0%"></div>
                </div>
              </div>
            </div>
            
            <!-- äº¤æ˜“çŠ¶æ€ -->
            <div class="trading-status" id="tradingStatusContainer">
              <h4 data-i18n="status_desc">Trading Result</h4>
              <div id="tradingStatus">â³ Patience</div>
            </div>
          </div>
        </div>
      </div>

  <!-- å¼•å…¥è„šæœ¬ -->
  <script src="language.js"></script>
  
  <!-- é¡µé¢è„šæœ¬ -->
  <script>
  // é¦–å…ˆç¡®ä¿ç¿»è¯‘å¯¹è±¡å­˜åœ¨
  if (!window.translations) {
    window.translations = {};
  }
  
  // ç¡®ä¿è‹±æ–‡ç¿»è¯‘å­˜åœ¨
  if (!window.translations.en) {
    window.translations.en = {};
  }
  
  // ç¡®ä¿ä¸­æ–‡ç¿»è¯‘å­˜åœ¨
  if (!window.translations.zh) {
    window.translations.zh = {};
  }
  
  // æ·»åŠ æ‰€æœ‰ç¿»è¯‘é”®
  window.translations.en.selected_date = "Selected Date";
  window.translations.en.history_records = "Daily Records";
  window.translations.en.no_history_yet = "No records yet";
  window.translations.en.trading_status = "Trading Status";
  window.translations.en.status_desc = "Trading Result";
  window.translations.en.passed = "Passed";
  window.translations.en.failed = "Failed";
  window.translations.en.patience = "Patience";
  window.translations.en.no_trades = "No Trades";
  
  window.translations.zh.selected_date = "é€‰æ‹©çš„æ—¥æœŸ";
  window.translations.zh.history_records = "æ¯æ—¥è®°å½•";
  window.translations.zh.no_history_yet = "æš‚æ— è®°å½•";
  window.translations.zh.trading_status = "äº¤æ˜“çŠ¶æ€";
  window.translations.zh.status_desc = "äº¤æ˜“ç»“æœ";
  window.translations.zh.passed = "å·²é€šè¿‡";
  window.translations.zh.failed = "å·²å¤±è´¥";
  window.translations.zh.patience = "éœ€è€å¿ƒ";
  window.translations.zh.no_trades = "æ— äº¤æ˜“";
  
  // å…¶ä»–å·²æœ‰çš„ç¿»è¯‘é”®
  window.translations.en.daily_profit_target = "Daily Profit Target";
  window.translations.en.daily_loss_limit = "Daily Loss Limit";
  
  window.translations.zh.daily_profit_target = "æ¯æ—¥ç›ˆåˆ©ç›®æ ‡";
  window.translations.zh.daily_loss_limit = "æ¯æ—¥äºæŸé™åˆ¶";

    // Supabase é…ç½®
    const SUPABASE_URL = "https://qwcfxuwerdpadntjxwvo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Y2Z4dXdlcmRwYWRudGp4d3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDQyNjcsImV4cCI6MjA4MzcyMDI2N30.5kMmJwYQQ0vugPplzXhHjeG2C3QB5CQZ39p57WQv1ag";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€å˜é‡
    let currentUserId = null;
    let dateHistoryData = {}; // å­˜å‚¨æ‰€æœ‰æ—¥æœŸçš„æ•°æ®
    let selectedDate = null; // å½“å‰é€‰æ‹©çš„æ—¥æœŸ
    
    // æ±‰å ¡èœå•
    const sidebar = document.getElementById("sidebar");
    const pageContent = document.getElementById("pageContent");
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    
    if (hamburgerBtn) {
      hamburgerBtn.addEventListener("click", () => {
        sidebar.classList.toggle("show");
        pageContent.classList.toggle("shift");
      });
    }
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAuth() {
      const { data: { session }, error } = await client.auth.getSession();
      
      if (!session) {
        window.location.href = 'login.html';
        return null;
      }
      
      currentUserId = session.user.id;
      return session;
    }

    // ç”Ÿæˆè¿ç»­çš„æ—¥æœŸåˆ—è¡¨ï¼ˆè¿‡å»7å¤©ï¼‰
    function generateDateRange(days = 7) {
      const dates = [];
      const today = new Date();
      
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        dates.push(dateStr);
      }
      
      return dates;
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
    function formatDateForDisplay(dateStr, lang = 'en') {
      const date = new Date(dateStr);
      
      if (lang === 'zh') {
        return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
      } else {
        const day = date.getDate();
        const month = date.toLocaleDateString('en-US', { month: 'long' });
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
      }
    }

    // è®¡ç®—æ—¥æœŸçŠ¶æ€
    function calculateDateStatus(totalPnl, profitTarget, lossLimit) {
      if (Math.abs(totalPnl) >= lossLimit && totalPnl < 0) {
        return { status: 'failed', statusClass: 'failed' };
      } else if (totalPnl >= profitTarget) {
        return { status: 'passed', statusClass: 'passed' };
      } else {
        return { status: 'patience', statusClass: 'patience' };
      }
    }

    // è·å–æŒ‡å®šæ—¥æœŸçš„èµ·å§‹ä½™é¢
    async function getDateStartingBalance(userId, targetDate) {
      try {
        const { currentBalance, dailyBalances } = await getBalanceByDate(userId);
        
        // æ‰¾åˆ°ç›®æ ‡æ—¥æœŸå‰ä¸€å¤©çš„æ—¥æœŸ
        const targetDateObj = new Date(targetDate);
        const previousDay = new Date(targetDateObj);
        previousDay.setDate(previousDay.getDate() - 1);
        const previousDayStr = previousDay.toISOString().split('T')[0];
        
        // æŸ¥æ‰¾å‰ä¸€å¤©çš„æœ€ç»ˆä½™é¢
        let startingBalance = 1000; // é»˜è®¤å€¼
        
        if (dailyBalances[previousDayStr]) {
          startingBalance = dailyBalances[previousDayStr];
        } else if (Object.keys(dailyBalances).length > 0) {
          // å¦‚æœæ²¡æœ‰å‰ä¸€å¤©çš„è®°å½•ï¼ŒæŸ¥æ‰¾æœ€è¿‘ä¸€å¤©çš„ä½™é¢
          const dates = Object.keys(dailyBalances).sort();
          let foundBalance = null;
          
          for (let i = dates.length - 1; i >= 0; i--) {
            if (dates[i] < targetDate) {
              foundBalance = dailyBalances[dates[i]];
              break;
            }
          }
          
          if (foundBalance) {
            startingBalance = foundBalance;
          }
        }
        
        // å¦‚æœä½™é¢ä¸º0æˆ–è´Ÿæ•°ï¼Œä½¿ç”¨åˆç†çš„é»˜è®¤å€¼
        if (startingBalance <= 0) {
          startingBalance = 1000;
        }
        
        return startingBalance;
        
      } catch (error) {
        console.error('Error getting date starting balance:', error);
        return 1000;
      }
    }

    // æŒ‰æ—¥æœŸè®¡ç®—æ¯æ—¥ç»“æŸæ—¶çš„ä½™é¢
    async function getBalanceByDate(userId) {
      try {
        const { data: trades, error } = await client
          .from('trades')
          .select('date, pnl_amount, balance_change, direction')
          .eq('user_id', userId)
          .order('date', { ascending: true })
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        if (!trades || trades.length === 0) {
          return { currentBalance: 1000, dailyBalances: {} };
        }
        
        const dailyBalances = {};
        let currentBalance = 0;
        
        trades.forEach(trade => {
          const date = trade.date;
          
          let change = 0;
          if (trade.direction === "Deposit" || trade.direction === "Withdrawal") {
            change = parseFloat(trade.balance_change || 0);
          } else {
            change = parseFloat(trade.pnl_amount || 0);
          }
          
          currentBalance += change;
          dailyBalances[date] = currentBalance;
        });
        
        return { currentBalance, dailyBalances };
        
      } catch (error) {
        console.error('Error getting balance by date:', error);
        return { currentBalance: 1000, dailyBalances: {} };
      }
    }

    // åŠ è½½æ‰€æœ‰æ—¥æœŸè®°å½•ï¼ˆåŒ…æ‹¬æ²¡æœ‰äº¤æ˜“çš„æ—¥æœŸï¼‰
    async function loadAllDateRecords(userId) {
      try {
        const emptyHistoryEl = document.getElementById('emptyHistory');
        const dateHistoryList = document.getElementById('dateHistoryList');
        
        if (!emptyHistoryEl || !dateHistoryList) return;
        
        // è·å–æœ€è¿‘7å¤©çš„æ—¥æœŸï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
        const dateRange = generateDateRange(7);
        const today = new Date().toISOString().split('T')[0];
        
        // è·å–è¿™äº›æ—¥æœŸçš„äº¤æ˜“è®°å½•
        const { data: allTrades, error } = await client
          .from('trades')
          .select('date, pnl_amount, balance_change, direction')
          .eq('user_id', userId)
          .in('date', dateRange)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        // æŒ‰æ—¥æœŸåˆ†ç»„è®¡ç®—ç›ˆäº
        const dateGroups = {};
        if (allTrades && allTrades.length > 0) {
          allTrades.forEach(trade => {
            const date = trade.date;
            if (!dateGroups[date]) {
              dateGroups[date] = { 
                totalPnl: 0, 
                tradeCount: 0,
                deposits: 0,
                withdrawals: 0,
                hasTrades: false
              };
            }
            
            if (trade.direction === 'Deposit') {
              dateGroups[date].deposits += parseFloat(trade.balance_change || 0);
              dateGroups[date].hasTrades = true;
            } else if (trade.direction === 'Withdrawal') {
              dateGroups[date].withdrawals += parseFloat(trade.balance_change || 0);
              dateGroups[date].hasTrades = true;
            } else if (trade.direction === 'Buy' || trade.direction === 'Sell') {
              dateGroups[date].totalPnl += parseFloat(trade.pnl_amount || 0);
              dateGroups[date].tradeCount++;
              dateGroups[date].hasTrades = true;
            }
          });
        }
        
        // ç¡®ä¿æ‰€æœ‰æ—¥æœŸéƒ½æœ‰æ•°æ®å¯¹è±¡
        dateRange.forEach(date => {
          if (!dateGroups[date]) {
            dateGroups[date] = { 
              totalPnl: 0, 
              tradeCount: 0,
              deposits: 0,
              withdrawals: 0,
              hasTrades: false
            };
          }
        });
        
        // è·å–æ‰€æœ‰æ—¥æœŸçš„ä½™é¢æ•°æ®
        const { currentBalance, dailyBalances } = await getBalanceByDate(userId);
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        dateHistoryList.innerHTML = '';
        dateHistoryData = {}; // æ¸…ç©ºç¼“å­˜
        
        const currentLang = localStorage.getItem('language') || 'en';
        
        // æŒ‰æ—¥æœŸå€’åºå¤„ç†ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
        const sortedDates = Object.keys(dateGroups).sort((a, b) => b.localeCompare(a));
        
        // ä¸ºæ¯ä¸ªæ—¥æœŸè·å–è¯¦ç»†æ•°æ®
        for (const date of sortedDates) {
          const data = dateGroups[date];
          const totalPnl = data.totalPnl;
          
          // è·å–è¯¥æ—¥æœŸçš„èµ·å§‹ä½™é¢
          const startingBalance = await getDateStartingBalance(userId, date);
          
          const profitTarget = startingBalance * 0.1;
          const lossLimit = startingBalance * 0.25;
          
          // è®¡ç®—çŠ¶æ€
          let statusInfo;
          if (!data.hasTrades) {
            // æ²¡æœ‰äº¤æ˜“çš„æ—¥å­æ€»æ˜¯ Patience
            statusInfo = { status: 'patience', statusClass: 'patience' };
          } else {
            statusInfo = calculateDateStatus(totalPnl, profitTarget, lossLimit);
          }
          
          // å­˜å‚¨æ—¥æœŸæ•°æ®
          dateHistoryData[date] = {
            date,
            totalPnl,
            startingBalance,
            profitTarget,
            lossLimit,
            status: statusInfo.status,
            statusClass: statusInfo.statusClass,
            hasTrades: data.hasTrades
          };
          
          // è·å–çŠ¶æ€æ–‡æœ¬
          let statusText = '';
          if (!data.hasTrades) {
            statusText = currentLang === 'zh' ? 'æ— äº¤æ˜“' : 'No Trades';
          } else if (window.translations && window.translations[currentLang] && window.translations[currentLang][statusInfo.status]) {
            statusText = window.translations[currentLang][statusInfo.status];
          } else {
            statusText = statusInfo.status;
          }
          
          // çŠ¶æ€å›¾æ ‡
          const statusIcons = {
            'passed': 'âœ…',
            'failed': 'âŒ',
            'patience': 'â³'
          };
          
          const statusIcon = !data.hasTrades ? 'ğŸ“Š' : (statusIcons[statusInfo.status] || 'â³');
          
          // åˆ›å»ºæ—¥æœŸè®°å½•é¡¹
          const historyItem = document.createElement('div');
          historyItem.className = `date-history-item ${statusInfo.statusClass} ${date === today ? 'active' : ''}`;
          historyItem.dataset.date = date;
          historyItem.dataset.status = statusInfo.status;
          historyItem.dataset.hasTrades = data.hasTrades;
          
          const formattedDate = formatDateForDisplay(date, currentLang);
          
          historyItem.innerHTML = `
            <div class="date-history-date">${formattedDate}</div>
            <div class="date-history-status">
              <span class="status-${statusInfo.statusClass}">(${statusText})</span>
              <span>${statusIcon}</span>
            </div>
          `;
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          historyItem.addEventListener('click', () => {
            selectDate(date);
          });
          
          dateHistoryList.appendChild(historyItem);
        }
        
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (sortedDates.length === 0) {
          emptyHistoryEl.style.display = 'flex';
        } else {
          emptyHistoryEl.style.display = 'none';
          
          // é»˜è®¤é€‰ä¸­ä»Šå¤©æˆ–æœ€è¿‘çš„æ—¥æœŸ
          const defaultDate = sortedDates.includes(today) ? today : sortedDates[0];
          selectDate(defaultDate);
        }
        
      } catch (error) {
        console.error('Error loading date records:', error);
      }
    }

    // é€‰æ‹©æ—¥æœŸå¹¶æ›´æ–°æ˜¾ç¤º
    async function selectDate(date) {
      try {
        selectedDate = date;
        
        // æ›´æ–°å·¦ä¾§åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.date-history-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.date === date) {
            item.classList.add('active');
          }
        });
        
        // è·å–æ—¥æœŸæ•°æ®
        const dateData = dateHistoryData[date];
        if (!dateData) {
          console.error('No data for date:', date);
          return;
        }
        
        const currentLang = localStorage.getItem('language') || 'en';
        const today = new Date().toISOString().split('T')[0];
        
        // æ›´æ–°é€‰æ‹©çš„æ—¥æœŸæ˜¾ç¤º
        const selectedDateEl = document.getElementById('selectedDateValue');
        if (selectedDateEl) {
          const formattedDate = formatDateForDisplay(date, currentLang);
          selectedDateEl.textContent = date === today ? 
            (currentLang === 'zh' ? 'ä»Šå¤©' : 'Today') : 
            formattedDate;
        }
        
        // æ›´æ–°å¡ç‰‡æ ‡é¢˜
        const cardTitle = document.querySelector('.combined-card h3');
        if (cardTitle) {
          cardTitle.textContent = currentLang === 'zh' ? 'äº¤æ˜“çŠ¶æ€' : 'Trading Status';
        }
        
        // æ›´æ–°ç›ˆåˆ©ç›®æ ‡å¡ç‰‡
        const profitTargetEl = document.getElementById('profitTarget');
        const profitProgressEl = document.getElementById('profitProgress');
        const profitTargetDescEl = document.getElementById('profitTargetDesc');
        
        if (profitTargetEl) {
          const profitAchieved = Math.max(0, dateData.totalPnl);
          const profitPercentage = dateData.profitTarget > 0 ? 
            Math.min(100, (profitAchieved / dateData.profitTarget) * 100) : 0;
          
          profitTargetEl.textContent = `${profitAchieved.toFixed(2)} / ${dateData.profitTarget.toFixed(2)}`;
          
          if (profitProgressEl) {
            profitProgressEl.style.width = `${profitPercentage}%`;
          }
          
          if (profitTargetDescEl) {
            profitTargetDescEl.textContent = currentLang === 'zh' ? 
              `10% çš„å½“æ—¥ä½™é¢ (${dateData.startingBalance.toFixed(2)})` :
              `10% of daily balance (${dateData.startingBalance.toFixed(2)})`;
          }
          
          // æ ¹æ®å®Œæˆåº¦è®¾ç½®é¢œè‰²
          if (dateData.totalPnl >= dateData.profitTarget) {
            profitTargetEl.style.color = '#10b981';
          } else if (dateData.totalPnl >= dateData.profitTarget * 0.5) {
            profitTargetEl.style.color = '#f59e0b';
          } else {
            profitTargetEl.style.color = '#3b82f6';
          }
        }
        
        // æ›´æ–°äºæŸé™åˆ¶å¡ç‰‡
        const lossLimitEl = document.getElementById('lossLimit');
        const lossProgressEl = document.getElementById('lossProgress');
        const lossLimitDescEl = document.getElementById('lossLimitDesc');
        
        if (lossLimitEl) {
          const todayLoss = Math.max(0, -dateData.totalPnl);
          const lossPercentage = dateData.lossLimit > 0 ? 
            Math.min(100, (todayLoss / dateData.lossLimit) * 100) : 0;
          
          lossLimitEl.textContent = `${todayLoss.toFixed(2)} / ${dateData.lossLimit.toFixed(2)}`;
          
          if (lossProgressEl) {
            lossProgressEl.style.width = `${lossPercentage}%`;
          }
          
          if (lossLimitDescEl) {
            lossLimitDescEl.textContent = currentLang === 'zh' ? 
              `25% çš„å½“æ—¥ä½™é¢ (${dateData.startingBalance.toFixed(2)})` :
              `25% of daily balance (${dateData.startingBalance.toFixed(2)})`;
          }
          
          // æ ¹æ®é£é™©ç¨‹åº¦è®¾ç½®é¢œè‰²
          if (todayLoss >= dateData.lossLimit) {
            lossLimitEl.style.color = '#ef4444';
          } else if (todayLoss >= dateData.lossLimit * 0.8) {
            lossLimitEl.style.color = '#f59e0b';
          } else {
            lossLimitEl.style.color = '#3b82f6';
          }
        }
        
        // æ›´æ–°äº¤æ˜“çŠ¶æ€
        const tradingStatusEl = document.getElementById('tradingStatus');
        const tradingStatusContainer = document.getElementById('tradingStatusContainer');
        
        if (tradingStatusEl && tradingStatusContainer) {
          let statusEmoji = '';
          let statusColorClass = '';
          let statusText = '';
          
          // å¦‚æœæ²¡æœ‰äº¤æ˜“ï¼Œæ˜¾ç¤ºæ— äº¤æ˜“çŠ¶æ€
          if (!dateData.hasTrades) {
            statusEmoji = 'ğŸ“Š';
            statusColorClass = 'status-patience-full';
            statusText = currentLang === 'zh' ? 'æ— äº¤æ˜“' : 'No Trades';
          } else {
            // æ ¹æ®çŠ¶æ€è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
            if (dateData.status === 'failed') {
              statusEmoji = 'âŒ';
              statusColorClass = 'status-failed-full';
            } else if (dateData.status === 'passed') {
              statusEmoji = 'âœ…';
              statusColorClass = 'status-passed-full';
            } else {
              statusEmoji = 'â³';
              statusColorClass = 'status-patience-full';
            }
            
            // è·å–çŠ¶æ€æ–‡æœ¬
            if (window.translations && window.translations[currentLang] && window.translations[currentLang][dateData.status]) {
              const translation = window.translations[currentLang][dateData.status];
              statusText = translation;
            } else {
              const defaultTexts = {
                'passed': 'Passed',
                'failed': 'Failed',
                'patience': 'Patience'
              };
              statusText = defaultTexts[dateData.status] || 'Patience';
            }
          }
          
          // æ›´æ–°æ˜¾ç¤º
          tradingStatusEl.textContent = `${statusEmoji} ${statusText}`;
          tradingStatusEl.className = '';
          tradingStatusEl.classList.add(statusColorClass);
          tradingStatusContainer.className = 'trading-status';
          tradingStatusContainer.classList.add(statusColorClass);
        }
        
        console.log('å·²é€‰æ‹©æ—¥æœŸ:', date, 'æ•°æ®:', dateData);
        
      } catch (error) {
        console.error('Error selecting date:', error);
      }
    }

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      checkAuth().then(session => {
        if (session && currentUserId) {
          // åŠ è½½æ‰€æœ‰æ—¥æœŸè®°å½•
          loadAllDateRecords(currentUserId);
          
          // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
          setInterval(() => {
            loadAllDateRecords(currentUserId);
          }, 60000);
        }
      });
      
      // åˆå§‹åŒ–è¯­è¨€
      if (window.initLanguage) {
        window.initLanguage();
      }
    });
  </script>
</body>
</html>